#!/usr/bin/env bash

set -e  # останавливаемся при любой ошибке

# -----------------------------------------------------------------------------
# Конфигурация
# -----------------------------------------------------------------------------

IMAGE_NAME="mvpipeline:latest"
CONTAINER_WORKDIR="/app"
DOCKERFILE_PATH="."

echo "=== Запуск MVPipeline в Docker ==="
echo "Image: ${IMAGE_NAME}"
echo "Workdir: ${CONTAINER_WORKDIR}"
echo ""

# -----------------------------------------------------------------------------
# Проверка: установлен ли docker
# -----------------------------------------------------------------------------

if ! command -v docker &> /dev/null; then
  echo "Ошибка: Docker не установлен или не доступен в PATH."
  exit 1
fi

# -----------------------------------------------------------------------------
# Проверка: существует ли docker образ
# Если нет — автоматически собираем
# -----------------------------------------------------------------------------

if [[ -z "$(docker images -q ${IMAGE_NAME} 2> /dev/null)" ]]; then
  echo "Docker образ ${IMAGE_NAME} не найден."
  echo "=== Сборка Docker образа ==="
  echo "Контекст: ${DOCKERFILE_PATH}"
  echo ""

  docker build -t ${IMAGE_NAME} ${DOCKERFILE_PATH}

  echo ""
  echo "=== Сборка завершена ==="
else
  echo "Docker образ ${IMAGE_NAME} найден."
fi

echo ""
echo "=== Запуск контейнера ==="
echo ""

# -----------------------------------------------------------------------------
# Запуск контейнера
# -----------------------------------------------------------------------------
# -v "$PWD:/app" → монтируем текущий проект внутрь контейнера
# -w /app        → рабочая директория внутри контейнера
# --rm           → удалить контейнер после завершения
# -it            → интерактивный режим (rich, tqdm, цветные логи)
# -----------------------------------------------------------------------------

docker run --rm -it \
  -v "$PWD:${CONTAINER_WORKDIR}" \
  -w "${CONTAINER_WORKDIR}" \
  ${IMAGE_NAME} \
  bash scripts/run_validation.sh

echo ""
echo "=== Docker run завершён ==="
