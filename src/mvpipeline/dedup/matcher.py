from pymatgen.analysis.structure_matcher import StructureMatcher
from pymatgen.core import Structure


class SimilarityChecker:
    """
    Проверяет, является ли кристаллическая структура дубликатом уже принятой.

    Использует pymatgen StructureMatcher для сравнения геометрии кристаллов,
    а также bucket-индексацию по (reduced_formula, spacegroup) для ускорения поиска.

    Почему это важно:
    Генеративные модели часто генерируют одну и ту же структуру несколько раз,
    иногда в слегка изменённом виде. Простое сравнение CIF как текста не подходит,
    так как одинаковые структуры могут быть записаны по-разному.

    Поэтому используется структурное сравнение, которое учитывает:
    - геометрию решётки,
    - симметрию,
    - расстояния между атомами,
    - допускает небольшие численные отклонения.

    Для ускорения структуры группируются по бакетам:
        key = (reduced_formula, spacegroup)

    Это резко снижает число сравнений и делает алгоритм масштабируемым.
    """

    def __init__(self):
        """
        Инициализация StructureMatcher и структуры хранения бакетов.

        StructureMatcher параметры:

        ltol (lattice tolerance)
            Допуск на различие параметров решётки.
            Например, 0.2 означает допустимое отклонение до 20%.

        stol (site tolerance)
            Допуск на различие позиций атомов (в долях решётки).

        angle_tol (angle tolerance)
            Допуск на различие углов решётки (в градусах).

        Эти параметры позволяют matcher считать структуры одинаковыми,
        даже если они немного искажены генератором.
        """
        self.matcher = StructureMatcher(
            ltol=0.2,
            stol=0.3,
            angle_tol=5,
        )

        # Buckets: индекс уже принятых структур для ускорения поиска дубликатов.
        #
        # Формат:
        #
        # {
        #   (formula, spacegroup): [Structure, Structure, ...],
        #   ...
        # }
        #
        # Пример:
        #
        # {
        #   ("Fe2O3", 167): [struct1, struct2],
        #   ("NiO", 225): [struct3]
        # }
        #
        # Это позволяет сравнивать новую структуру только с похожими,
        # а не со всеми ранее принятыми структурами.
        self._buckets = {}

    def is_duplicate(self, struct: Structure, formula: str, sg: int) -> bool:
        """
        Проверяет, является ли структура дубликатом уже принятой.

        Алгоритм:

        1. Определяем бакет по (formula, spacegroup)
        2. Если бакет пуст → структура точно новая
        3. Если бакет существует → сравниваем структуру с каждой в бакете
        4. Если matcher.fit(...) возвращает True → структура дубликат

        Parameters
        ----------
        struct : Structure
            Новая структура, которую нужно проверить.

        formula : str
            Приведённая формула структуры (например "Fe2O3").

        sg : int
            Номер пространственной группы (spacegroup).

        Returns
        -------
        bool
            True  → структура является дубликатом
            False → структура новая
        """

        # Формируем ключ бакета
        key = (formula, sg)

        # Если такого бакета ещё нет,
        # значит структуры с такой формулой и симметрией ещё не было
        if key not in self._buckets:
            return False

        # Сравниваем только с структурами внутри соответствующего бакета.
        # Это резко ускоряет работу по сравнению со сравнением со всеми структурами.
        for existing in self._buckets[key]:

            # matcher.fit проверяет геометрическую эквивалентность структур.
            # Возвращает True, если структуры совпадают с учётом допусков.
            if self.matcher.fit(struct, existing):
                return True

        # Если совпадений не найдено → структура новая
        return False

    def add_to_accepted(self, struct: Structure, formula: str, sg: int):
        """
        Добавляет валидированную структуру в индекс (bucket).

        После этого будущие структуры будут сравниваться с ней
        для обнаружения дубликатов.

        Parameters
        ----------
        struct : Structure
            Структура для добавления.

        formula : str
            Приведённая формула структуры.

        sg : int
            Номер пространственной группы.
        """

        key = (formula, sg)

        # Если бакет ещё не существует — создаём
        if key not in self._buckets:
            self._buckets[key] = []

        # Добавляем структуру в бакет
        self._buckets[key].append(struct)
